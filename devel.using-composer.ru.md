Использование Composer
======================

![php-composer](https://github.com/Cotonti/dev-documentation/assets/1021886/d32e7170-0270-44ac-bf12-668a52222942)

В версии Cotonti Siena 0.9.23 добавлена поддержка [Composer](https://getcomposer.org/) - менеджер пакетов для PHP.

## Что такое Composer

**Composer – это пакетный менеджер зависимостей**, предназначенный для упрощения загрузки и установки сторонних php библиотек в проект. 
Например, с его помощью очень легко добавить в разрабатываемое расширение или проект необходимые библиотеки.

**composer.json** - это текстовый файл, в котором в формате JSON описаны все сторонние библиотеки (пакеты) от которых зависит данный
проект. Кроме того он может содержать информацию о проекта, минимальную версию PHP, необходимую для работы проекта, необходимые 
расширения PHP.

**composer.lock** - содержит текущий список всех установленных зависимостей и их версии. Основное назначение этого файла
заключается в полном сохранении среды, в которой ведется разработка и тестирование проекта.  
Например если вы ведёте коллективную разработку, то ваш коллега скачав (pull) проект с гит-репозитория должен получить 
тоже окружение и версии всех пакетов, что и у вас.  
При деплое проекта в продакшен нужно на сервере полуить те же самые версии пакетов, что и в dev среде. 
Это позволяет убедиться в том, что в любом месте, где разворачивается получает ваш проект, пакетное окружение будет 
идентично тому, которое вы использовали при разработке, и помогает избежать ошибок, которые могли бы возникнуть из-за
обновления версий.

## Использование Composer при разработке расширений.

Прежде всего у Вас должен быть [установлен сам Composer](https://getcomposer.org/doc/00-intro.md#installation-linux-unix-macos).

Здесь мы добавим в создаваемое расширение Cotonti HTTP клиент [Guzzle](https://docs.guzzlephp.org), который позволяет отправлять как синхронные,
так и асинхронные запросы к удаленном серверам, используя один и тот же интерфейс. Отличный инструмент для интеграции с различными API.

А также мы будем загружать файлы в удаленное хранилище.

Эти фичи будут использоваться только для примера и никак между собой не связаны.

Итак приступим.

Следуя инструкциям с [по установке Guzzle](https://docs.guzzlephp.org/en/stable/overview.html#installation) добавим в файл **composer.json**
который находится в корне проекта в секцию 

```json
"guzzlehttp/guzzle": "^7.8"
```

Получится что то вроде этого:

```json
"require": {
    "php": ">=5.6",
    "ext-gd": "*",
    "ext-mbstring": "*",
    "ext-json": "*",
    "ext-hash": "*",
    "ext-pdo": "*",
    "guzzlehttp/guzzle": "^7.8"
},
```

Далее в коммандной строке выполнить:
```shell
> composer update
```
Эта команда обновит все зависимости установленные в проекте до последних версий (в соответствии с **composer.json**), 
установит новые зависимсоти, которые появились в файле **composer.json** и удалит те, которых в этом файле больше нет.
После этого Composer обновит файл **composer.lock**.

**Внимание пользователи Windows**. Composer для Windows [**имеет один баг**](https://github.com/composer/composer/issues/6251)
и может в файле **lib/composer/autoload_static.php** сделать что то такое:

```php
public static $fallbackDirsPsr4 = array (
  0 => 'C:\\OpenServerData\\domains\\lily-software.loc\\public_html\\lib',
);
```
Надо вернуть как было:
```php
public static $fallbackDirsPsr4 = array (
  0 => DIR . '/../..' . '/lib',
);
```

Теперь наш HTTP клиент готов к использованию.

В PHP-файл нашего расширения добавим

```php
<?php

use GuzzleHttp\Client;

// Создаем экземпляр клиента с базовым URI
$client = new Client(['base_uri' => 'https://foo.com/api/']);

// Отправим POST-запросов application/x-www-form-urlencoded
$response = $client->request('POST', '/test', [
  'form_params' => [
      'field_name' => 'abc',
      'other_field' => '123',
      'nested_field' => [
          'nested' => 'hello',
      ],
  ],
]);

$body = $response->getBody();
echo $body;
```

Просто, не так ли?
